define ("mod_lanebs/modal_search",["exports","jquery","core/ajax","core/modal_factory","core/modal_events","core/notification","core/modal","core/custom_interaction_events","core/modal_registry","mod_lanebs/modal_book","mod_lanebs/modal_book_handle"],function(a,b,c,d,e,f,g,h,i,j,k){b.fn.serializeAssoc=function(){var c={};b.each(this.serializeArray(),function(d,e){var f=e.name.match(/(.*?)\[(.*?)\]/);if(null!==f){var a=f[1],g=f[2];if(!c[a]){c[a]=[]}if(!g.length){g=c[a].length}if(c[a][g]){if(b.isArray(c[a][g])){c[a][g].push(e.value)}else{c[a][g]=[];c[a][g].push(e.value)}}else{c[a][g]=e.value}}else{if(c[e.name]){if(b.isArray(c[e.name])){c[e.name].push(e.value)}else{c[e.name]=[];c[e.name].push(e.value)}}else{c[e.name]=e.value}}});return c};var l={SEARCH_TEXTBOX:"[data-action='search_text']",START_SEARCH:"[data-action='search_button']",START_SEARCH_CLEAR:"[name='clear_search']",CANCEL_BUTTON:"[data-action='cancel_button']",CONTENT_BLOCK:"[data-action='content_block']",BREADCRUMBS:".breadcrumbs p",CONTENT_NAME:"[name='content_name']",TRIGGER_BOOK:".trigger_book",ADD_BOOK:"[name='add_book']",CATEGORY_BUTTON:"[data-action='category_tree']",CATEGORY_BLOCK:"[data-action='categories']",BOOK_PAGINATION:"#books_pagination li.page-item",START_PAGE_CLASS:"page-start",END_PAGE_CLASS:"page-end",PROGRESS:".loader"},m=10,n=function(a){g.call(this,a);if(!this.getBody().find(l.SEARCH_TEXTBOX).length){f.exception({message:"text box not found"})}if(!this.getBody().find(l.START_SEARCH).length){f.exception({message:"search button not found"})}};n.TYPE="mod_lanebs-search";n.prototype=Object.create(g.prototype);n.prototype.constructor=n;n.prototype.breadcrumbs={};n.prototype.registerEventListeners=function(){g.prototype.registerEventListeners.call(this);var a=function(a){a.preventDefault();a.stopPropagation();var c=b(l.CATEGORY_BLOCK).attr("data-id"),d={searchParam:b(a.target.form).serializeAssoc(),page:1,limit:m,catId:c};b(l.PROGRESS).toggleClass("hide");n.prototype.getAjaxCall("mod_lanebs_search_books",d,n.prototype.getSearchResult).then(function(){n.prototype.resetPagination();b(l.PROGRESS).toggleClass("hide")})};this.getModal().on(h.events.activate,l.START_SEARCH,a.bind(this));this.getModal().on("click",l.START_SEARCH_CLEAR,function(a){a.preventDefault();a.stopPropagation();b(l.SEARCH_TEXTBOX).val("");b(l.START_SEARCH).trigger("click");return!1});this.getModal().on("keypress",l.SEARCH_TEXTBOX,function disabledEnterSubmit(b){if(13===b.keyCode){a(b);return!1}}.bind(this));this.getModal().on(h.events.activate,l.BOOK_PAGINATION,function setPagination(a){if(b(a.currentTarget).hasClass("disabled")){return!0}var c,d;if(b(l.CONTENT_BLOCK).attr("data-page")===void 0){d=0}else{d=parseInt(b(l.CONTENT_BLOCK).attr("data-page"))}if(b(a.currentTarget).hasClass(l.START_PAGE_CLASS)){if(0<d){c=1}else{c=0}}else if(b(a.currentTarget).hasClass(l.END_PAGE_CLASS)){c=d}else{c=parseInt(b(a.currentTarget).attr("data-page"))}var e=b(l.CATEGORY_BLOCK).attr("data-id"),f={searchParam:{searchString:b(l.SEARCH_TEXTBOX).val()},page:c,limit:m,catId:e},g=b(l.BOOK_PAGINATION).find("a.prev").closest("li.page-item"),h=b(l.BOOK_PAGINATION).find("a.next").closest("li.page-item"),i=b(l.BOOK_PAGINATION).find("a.active").closest("li.page-item");if(2<=c){b(g).attr("data-page",c-1);b(g).removeClass("disabled")}else if(1===c){b(g).attr("data-page",c-1);b(g).addClass("disabled")}if(d===c){b(h).addClass("disabled")}else{b(h).removeClass("disabled")}b(h).attr("data-page",c+1);b(i).attr("data-page",c);b(i).find("a.active").text(c+" \u0438\u0437 "+d);if(0!==c&&0!==d){n.prototype.getAjaxCall("mod_lanebs_search_books",f,n.prototype.getSearchResult)}}.bind(this));this.getModal().on("keydown",l.CONTENT_NAME,function disabledKeyUp(a){if(!1!==a.keyCode){a.preventDefault();return!1}}.bind(this));this.getModal().on(h.events.activate,l.CANCEL_BUTTON,function(){b(this).trigger("hide")}.bind(this));this.getModal().on(h.events.activate,l.CATEGORY_BUTTON,function getCategoryTree(a){a.preventDefault();a.stopPropagation();n.prototype.getAjaxCall("mod_lanebs_category_tree",{categoryId:[null]},n.prototype.printCategories)}.bind(this))};n.prototype.getSearchResult=function(a){b(l.CONTENT_BLOCK).empty();var c=Math.ceil(a.body.total/m);if(a.body.items.length){b.each(a.body.items,function(a,c){var d="<a class=\"\" data-toggle=\"collapse\" href=\"#collapseDescription"+c.id+"\" role=\"button\">\u041F\u043E\u0441\u043C\u043E\u0442\u0440\u0435\u0442\u044C \u043E\u043F\u0438\u0441\u0430\u043D\u0438\u0435</a><div class=\"collapse\" id=\"collapseDescription"+c.id+"\">"+c.description+"</div>",e="<span class=\"book_author\">"+c.author+"</span><br>";if(null===c.description||""===c.description){c.description="";d=""}if(null===c.author||""===c.author){c.author="";e=""}b(l.CONTENT_BLOCK).append("<div class=\"item d-flex\" data-id=\""+c.id+"\"><div class=\"icon\" style=\"flex:0.03;\"><mat-icon class=\"mat-icon material-icons\" style=\"color:#4285f4;\" role=\"img\">book</mat-icon></div><div class=\"item_content\" style=\"flex:0.75;\">"+e+"<span class=\"book_title\">"+c.title+"</span><br>"+d+"</div><div style=\"flex:0.23;\"><button type=\"button\" name=\"add_book\" class=\"btn btn-sm ml-3\" style=\"color: #174c8d;background-color: white;border-color: #4285f4;\">\u0414\u043E\u0431\u0430\u0432\u0438\u0442\u044C</button><button type=\"button\" class=\"trigger_book btn btn-sm ml-3 float-right\" style=\"color: #174c8d;background-color: white;border-color: #4285f4;\">\u041F\u0440\u0435\u0434\u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440</button><br><span class=\"book_year float-right\" style=\"margin-top:10px;\">"+c.year+"</span><br></div></div><hr style=\"margin-top:5px;\">")})}else{b(l.CONTENT_BLOCK).append("<div class=\"item\">\u041A\u043D\u0438\u0433\u0438 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B</div>")}b(l.CONTENT_BLOCK).attr("data-page",c);b(l.TRIGGER_BOOK).on("click",function(a){k.init(a,"\u041F\u0440\u0435\u0434\u043F\u0440\u043E\u0441\u043C\u043E\u0442\u0440")});b(l.ADD_BOOK).on("click",function(a){var c=b(a.target).closest(".item").attr("data-id"),d=b("[name=\"content_name\"]");d.val(b(a.target).closest(".item").find(".item_content .book_title").text());d.removeClass("is-invalid");d.siblings("#id_error_content_name").text("");b("[name=\"content\"]").val(c);b(l.CANCEL_BUTTON).trigger("click")})};n.prototype.printCategories=function(a){b(l.CATEGORY_BLOCK).empty();b.each(a.body.items,function(c,d){if(!1===d.available){return!1}b(l.CATEGORY_BLOCK).append("<div style=\"cursor:pointer;color:#174c8d;background-color:white;\" class=\"item btn-sm\" data-id=\""+d.id+"\" data-expand=\""+d.hasChild+"\" data-parent=\""+d.parent_id+"\"><span>"+d.name+"</span></div>");b(l.CATEGORY_BLOCK).find("[data-id=\""+d.id+"\"]").click({item:d},function(c){c.stopPropagation();c.preventDefault();var e=b(c.currentTarget).attr("data-id");b(l.CATEGORY_BLOCK).attr("data-id",e);n.prototype.clearCurrentCrumb(a.body.items);n.prototype.breadcrumbs[b(this).find("span").text()]=d;if(d.hasChild){var f={categoryId:[e]};n.prototype.getAjaxCall("mod_lanebs_category_tree",f,n.prototype.printCategories)}else{if(b(this).hasClass("bg-primary")){b(this).removeClass("bg-primary");var g=b(l.CATEGORY_BLOCK).find(".item:last").attr("data-parent");b(l.CATEGORY_BLOCK).attr("data-id",g);e=g;n.prototype.clearCurrentCrumb(a.body.items)}else{b(this).addClass("bg-primary");b(this).siblings().removeClass("bg-primary");b(l.CATEGORY_BLOCK).attr("data-id",e)}}n.prototype.printBreadcrumbs();b(l.START_SEARCH).trigger("click")})});var c=b(l.CATEGORY_BLOCK).find(".item:last").attr("data-parent");b(l.CATEGORY_BLOCK).prepend("<div style=\"cursor:pointer;margin-bottom:15px;color:#174c8d;background-color:white;\" class=\"btn-sm category_back\" data-id=\""+c+"\"><span>\u041D\u0410\u0417\u0410\u0414</span></div>");b(l.CATEGORY_BLOCK).find(".category_back").on("click",function(){var a=b(this).attr("data-id"),c=n.prototype.searchParentId(a);if(null===c){c="null"}b(l.CATEGORY_BLOCK).attr("data-id",c);var d={categoryId:[c]};if(0<b(l.CATEGORY_BLOCK).find(".item.bg-primary").length){n.prototype.clearCrumbs(2)}else{n.prototype.clearCrumbs(1)}n.prototype.printBreadcrumbs();n.prototype.getAjaxCall("mod_lanebs_category_tree",d,n.prototype.printCategories)})};n.prototype.printBreadcrumbs=function(){var a=n.prototype.breadcrumbs,c="";b(l.BREADCRUMBS).empty();b.each(a,function(a,b){c+="<span class=\"item\" data-id=\""+b.id+"\">"+a+"</span> -> "});c=c.slice(0,-3);b(l.BREADCRUMBS).append(c)};n.prototype.getAjaxCall=function(a,b,d){return c.call([{methodname:a,args:b}])[0].then(function(a){return a}).done(function(a){d(JSON.parse(a.body));return!0}).fail(function(a){alert(a);return!1})};n.prototype.resetPagination=function(){var a=parseInt(b(l.CONTENT_BLOCK).attr("data-page"));b(l.BOOK_PAGINATION).find("a.prev").closest("li.page-item").addClass("disabled");b(l.BOOK_PAGINATION).find("a.prev").closest("li.page-item").attr("data-page",0);b(l.BOOK_PAGINATION).find("a.active").closest("li.page-item").attr("data-page",1);b(l.BOOK_PAGINATION).find("a.next").closest("li.page-item").attr("data-page",2);if(1<a){b(l.BOOK_PAGINATION).find("a.active").text("1 \u0438\u0437 "+a);b(l.BOOK_PAGINATION).find("a.next").closest("li.page-item").removeClass("disabled")}else{b(l.BOOK_PAGINATION).find("a.active").text(a+" \u0438\u0437 "+a);b(l.BOOK_PAGINATION).find("a.next").closest("li.page-item").addClass("disabled")}};n.prototype.clearCurrentCrumb=function(a){var c=n.prototype.breadcrumbs,d=c[Object.keys(c)[Object.keys(c).length-1]];b.each(a,function(a,b){if(void 0!==d){if(b.id===d.id){delete n.prototype.breadcrumbs[b.name]}}})};n.prototype.clearCrumbs=function(a){for(var b=null,c=null,d=0;d<a;d++){b=Object.keys(n.prototype.breadcrumbs);c=b[b.length-1];delete n.prototype.breadcrumbs[c]}};n.prototype.searchParentId=function(a){var c=null;b.each(n.prototype.breadcrumbs,function(b,d){if(d.id==a){c=d.parent_id}});return c};i.register(n.TYPE,n,"mod_lanebs/modal_search");return n});
//# sourceMappingURL=modal_search.min.js.map
